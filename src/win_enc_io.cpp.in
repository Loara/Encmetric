extern "C"{
#include <windows.h>
}
#include <encmetric/enc_io.hpp>
using namespace adv;

size_t adv::stdin_getChrs(iochar_pt ptr, size_t len){
	HANDLE std_in = GetStdHandle(STD_INPUT_HANDLE);
	if(std_in == NULL || std_in == INVALID_HANDLE_VALUE)
		throw encoding_error{"Cannot get the stdin handle"};
	DWORD chrRem = static_cast<DWORD>(len);
	if(chrRem != len)
		throw encoding_error{"Too many characters (need patch)"};
	DWORD siz;
	if(ReadConsoleW(std_in, ptr.data(), chrRem, &siz, NULL) == 0)
		throw encoding_error{"IO error"};
	size_t chrRead=0;
	while(siz > 0){
		//number of dword
		DWORD dwsiz = static_cast<DWORD>(ptr.chLen())/2;
		if(dwsiz > siz){
			DWORD y;
			ptr += 2*siz;
			//read half-character
			if(ReadConsoleW(std_in, ptr.data(), dwsiz - siz, &y, NULL) == 0)
				throw encoding_error{"IO error"};
			chrRead++;
			break;
		}
		siz -= dwsiz;
		ptr.next();
		chrRead++;	
	}
	return chrRead;
}

size_t adv::stdout_putChrs(c_iochar_pt ptr, size_t len){
	HANDLE std_out = GetStdHandle(STD_OUTPUT_HANDLE);
	if(std_out == NULL || std_out == INVALID_HANDLE_VALUE)
		throw encoding_error{"Cannot get the stdout handle"};
	DWORD chrRem = static_cast<DWORD>(len);
	if(chrRem != len)
		throw encoding_error{"Too many characters (need patch)"};
	DWORD siz;
	if(WriteConsoleW(std_out, ptr.data(), chrRem, &siz, NULL) == 0)
		throw encoding_error{"IO error"};
	size_t chrRead=0;
	while(siz > 0){
		//number of dword
		DWORD dwsiz = static_cast<DWORD>(ptr.chLen())/2;
		if(dwsiz > siz){
			DWORD y;
			ptr += 2*siz;
			//read half-character
			if(WriteConsoleW(std_out, ptr.data(), dwsiz - siz, &y, NULL) == 0)
				throw encoding_error{"IO error"};
			chrRead++;
			break;
		}
		siz -= dwsiz;
		ptr.next();
		chrRead++;	
	}
	return chrRead;
}
size_t adv::stderr_putChrs(c_iochar_pt ptr, size_t len){
	HANDLE std_out = GetStdHandle(STD_ERROR_HANDLE);
	if(std_out == NULL || std_out == INVALID_HANDLE_VALUE)
		throw encoding_error{"Cannot get the stdout handle"};
	DWORD chrRem = static_cast<DWORD>(len);
	if(chrRem != len)
		throw encoding_error{"Too many characters (need patch)"};
	DWORD siz;
	if(WriteConsoleW(std_out, ptr.data(), chrRem, &siz, NULL) == 0)
		throw encoding_error{"IO error"};
	size_t chrRead=0;
	while(siz > 0){
		//number of dword
		DWORD dwsiz = static_cast<DWORD>(ptr.chLen())/2;
		if(dwsiz > siz){
			DWORD y;
			ptr += 2*siz;
			//read half-character
			if(WriteConsoleW(std_out, ptr.data(), dwsiz - siz, &y, NULL) == 0)
				throw encoding_error{"IO error"};
			chrRead++;
			break;
		}
		siz -= dwsiz;
		ptr.next();
		chrRead++;	
	}
	return chrRead;
}
